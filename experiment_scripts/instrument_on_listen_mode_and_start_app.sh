#!/bin/bash

# usage : instrument_and_start.sh apk_path 
# example : ./instrument_without_odile_on_listen_mode_and_start_app.sh 
#				android_frida_tools/apks/locker-fe666e209e094968d3178ecf0cf817164c26d5501ed3cd9a80da786a4a3f3dc4.apk	
#                      /media/lavoisier/ee9567d1-e98a-411a-8cea-516195e51630/odile_scalability_evaluation_on_many_apps
# Note : # The second is the external storage global workspace (to store datas-eg all generated files)
#
MISC=x86
echo "-----> setting the global workspace " 

#The project folder
GLOBAL_WORKSPACE="/home/lavoisier/svn_workspace/wapet/security/fridaDroid_final_project"

#the jar file of louison giztinger instrumenter.
INSTRUMENTER_JAR_FILE=$GLOBAL_WORKSPACE/instrumenter_related_tools/groom/static/build/libs/killerdroid-static-3.0.jar 
#the instrumenter config files (the real file we will consider is main.json_template)
INSTRUMENTER_CONFIG_FILE=$GLOBAL_WORKSPACE/instrumenter_related_tools/groom/static/main.json

#The gadget so files folder  (I reused the same as with odile,
#if it does not work I will used the old one present on Louison Instrumenter folder) 
GADGET_SO_FILES=$GLOBAL_WORKSPACE/frida_related_tools/gadget_so_files



app_file_name_without_extension=$(basename -s .apk $1)
TMP_FOLDER=$2/instrumentation_tmp_folder/${app_file_name_without_extension}

rm -rf $TMP_FOLDER
mkdir $TMP_FOLDER



#All temporary files generated by this script


echo "MISC = $MISC"

if [ -z "$1" ] 
   then
	echo "No apk path supplied as argument "; exit 1;
else
        echo "testing apk $1"     
	echo "Ensure you have already started the emulator!!!"
	#adb root
	
	echo "----->  Getting the name of the apk ";   
	pkg=$(aapt dump badging $1|awk -F" " '/package/ {print $2}'|awk -F"'" '/name=/ {print $2}')
	act=$(aapt dump badging $1|awk -F" " '/launchable-activity/ {print $2}'|awk -F"'" '/name=/ {print $2}')
	echo "package name : $pkg"
	echo "start activity name : $act"

	echo "----->  Config files modification  1"; 	
	echo "----->  For the instrumenter (we configure the tmp folder where the output will be created)"


	
	(echo "$TMP_FOLDER" | sed -r 's/\//\\\//g') > to_delete
	tmp_folder_prepared_for_sed=$(cat to_delete)
	rm to_delete

	sed "s/instrumented_folder/${tmp_folder_prepared_for_sed}\/instrumented_apks_of_$pkg/g" ${INSTRUMENTER_CONFIG_FILE}_template  > ${TMP_FOLDER}/instrumenter_config_file.json_for_${pkg}
	
	

    echo "----->  making the lib file : cleaning repositories "; 
	cp -rfv $TMP_FOLDER/lib.zip ~/.local/share/Trash/files   
    rm -rfv $TMP_FOLDER/lib.zip 


	if [ "$MISC" == "x86" ]
	then
		echo "----->  Making the x86 lib folder"; 
               	mkdir $TMP_FOLDER/$MISC/

	      	cp  -rfv  $TMP_FOLDER/$MISC/* ~/.local/share/Trash/files 
	       	rm  -rfv  $TMP_FOLDER/$MISC/*
	        
		echo "inside the lib zip file, you have only the frida gadget so file;
                  the tracer js file is sent from the python file of the project android-frida-tool; 
                  the config file is not nessecary because de default frida mode is 
                  listen mode (https://frida.re/docs/gadget/#listen)"
		cp -v $GADGET_SO_FILES/gadget_${MISC}.so $TMP_FOLDER/$MISC/libgadget.so
		cd $TMP_FOLDER
		zip lib.zip $MISC $MISC/*;
		cd $GLOBAL_WORKSPACE
     			
	elif [ "$MISC" == "arm64" ]
	then
		echo "----->  Making the arm64 lib folder, it is arm64-v8a in reality"; 
		mkdir $TMP_FOLDER/${MISC}-v8a/
		
	      	cp  -rfv  $TMP_FOLDER/${MISC}-v8a/* ~/.local/share/Trash/files 
	       	rm  -rfv  $TMP_FOLDER/${MISC}-v8a/*
		
		echo "inside the lib zip file, you have the frida gadget so file, the tracer js file and the config file"
		cp -v $GADGET_SO_FILES/gadget_${MISC}.so $TMP_FOLDER/${MISC}-v8a/libgadget.so
		cd $TMP_FOLDER
		zip lib.zip ${MISC}-v8a ${MISC}-v8a/*;
                cd $GLOBAL_WORKSPACE
	else
		echo "-----> ERROR : Misc not supported"; exit 1;
	fi 

	#mv lib.zip $TMP_FOLDER/


	echo  "----->  Instrumentation      "; 
	cp -rfv  temp-* ~/.local/share/Trash/files   
	rm -rfv  temp-*


	INSTRUMENTER_OUTPUT_FOLDER=$TMP_FOLDER/instrumented_apks_of_$pkg

	cp -rfv $TMP_FOLDER/instrumented_apks_of_* ~/.local/share/Trash/files  
    rm -rfv $TMP_FOLDER/instrumented_apks_of_*

	mkdir $INSTRUMENTER_OUTPUT_FOLDER
	
	echo "-----> the instrumented apks of this apk is $INSTRUMENTER_OUTPUT_FOLDER ,"
        echo "-----> the config file is ${TMP_FOLDER}/instrumenter_config_file.json_for_${pkg} "; 

	java -jar -Xss100M -XX:CICompilerCount=2 $INSTRUMENTER_JAR_FILE \
		       -c ${TMP_FOLDER}/instrumenter_config_file.json_for_${pkg}  \
		         -a $1

	cp -rfv  temp-*/sootOutput/*soot-frida-aligned-signed.apk $INSTRUMENTER_OUTPUT_FOLDER
	echo "----->  running the apk (The emulator need to be started)"; 
	
	adb uninstall $pkg
	repackagedApk="$(ls $INSTRUMENTER_OUTPUT_FOLDER)"
	adb install $INSTRUMENTER_OUTPUT_FOLDER/$repackagedApk
	#if act=""    
		#comp=$(adb shell cmd package resolve-activity --brief -c android.intent.category.LAUNCHER $pkg | tail -1);
        	#adb shell cmd activity start-activity $comp
        # or using monkey this is the last option. com.garbege.background.cutout
		#adb shell monkey -p com.garbege.background.cutout -c android.intent.category.LAUNCHER 1

	adb shell am start -n $pkg/$act
	spd-say done;
fi
echo " Test realised on $(date)"; 


